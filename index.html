<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AniLabs</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#070b18;--bg2:#0c1330;--glass:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.15);
  --accent:#6ee7ff;--accent2:#a78bfa;
  --text:#fff;--muted:#aab0d6;
}
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;color:var(--text);
  background:radial-gradient(circle at top,var(--bg2),var(--bg));
}
.screen{display:none}
.screen.active{display:block}

.header{
  display:flex;align-items:center;gap:12px;
  padding:18px;font-size:22px;font-weight:700
}
.header img{
  width:40px;height:40px;border-radius:50%
}
.back{padding:12px;color:var(--accent)}

.grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:14px;padding:16px
}
.card{
  background:var(--glass);
  border:1px solid var(--border);
  border-radius:20px;
  padding:16px;
  transition:.25s;
}
.card:active{transform:scale(.97)}

.chat{
  padding:16px;
  padding-bottom:140px
}
.msg{
  max-width:80%;
  margin-bottom:10px;
  padding:10px 14px;
  border-radius:16px;
  font-size:14px;
  opacity:0;
  transform:translateY(10px);
  animation:fade .3s forwards;
}
@keyframes fade{
  to{opacity:1;transform:none}
}
.user{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#000;margin-left:auto
}
.bot{
  background:var(--glass);
  border:1px solid var(--border)
}

.input-box{
  position:fixed;bottom:64px;left:0;right:0;
  padding:12px;display:flex;gap:10px;
  background:#0a0e28
}
.input-box input{
  flex:1;padding:12px;
  border-radius:14px;border:none
}
.input-box button{
  padding:12px 18px;
  border-radius:14px;border:none;
  background:linear-gradient(90deg,var(--accent),var(--accent2))
}

/* modal */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
.modal.active{display:flex}
.modal-box{
  background:#0c1330;
  border-radius:20px;
  padding:20px;
  text-align:center;
  width:280px
}
.modal-box button{
  margin-top:12px;
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:linear-gradient(90deg,var(--accent),var(--accent2))
}
</style>
</head>

<body>

<div class="screen active" id="home">
  <div class="header">AniLabs</div>
  <div class="grid">
    <div class="card" onclick="openScreen('characters')">üßç –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
    <div class="card" onclick="openScreen('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>
</div>

<div class="screen" id="profile">
  <div class="back" onclick="openScreen('home')">‚Üê –ù–∞–∑–∞–¥</div>
  <div class="header">–ü—Ä–æ—Ñ–∏–ª—å</div>
  <div class="grid">
    <div class="card">üîÆ –¢–æ–∫–µ–Ω—ã<br><span id="tokensEl"></span></div>
    <div class="card">üìä –°–æ–æ–±—â–µ–Ω–∏—è<br><span id="statsText"></span></div>
  </div>
</div>

<div class="screen" id="characters">
  <div class="back" onclick="openScreen('home')">‚Üê –ù–∞–∑–∞–¥</div>
  <div class="header">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
  <div class="grid" id="characterList"></div>
</div>

<div class="screen" id="chat">
  <div class="back" onclick="openScreen('characters')">‚Üê –ù–∞–∑–∞–¥</div>
  <div class="header">
    <img id="chatAvatar">
    <span id="chatName"></span>
  </div>
  <div class="chat" id="chatMessages"></div>
  <div class="input-box">
    <input id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."/>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<div class="modal" id="tokenModal">
  <div class="modal-box">
    <h3>–¢—Ä–µ–±—É–µ—Ç—Å—è 1 —Ç–æ–∫–µ–Ω</h3>
    <p>–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</p>
    <button onclick="closeModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
  </div>
</div>

<script>
const API_URL = "https://anilabs.onrender.com";

const characters=[
 {name:'–†–∏–∞—Å –ì—Ä–µ–º–æ—Ä–∏',avatar:'https://i.imgur.com/6Z8FJ9M.png'}
];

let current=null;
let tokens=Number(localStorage.getItem('tokens'))||2;
let stats=JSON.parse(localStorage.getItem('stats'))||{sent:0,received:0};

function openScreen(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 updateProfile();
}

function renderCharacters(){
 characterList.innerHTML='';
 characters.forEach(c=>{
  const d=document.createElement('div');
  d.className='card';
  d.innerHTML=`<img src="${c.avatar}" style="width:48px;border-radius:50%"><br>${c.name}`;
  d.onclick=()=>openChat(c);
  characterList.appendChild(d);
 });
}

function openChat(c){
 current=c;
 chatName.textContent=c.name;
 chatAvatar.src=c.avatar;
 chatMessages.innerHTML='';
 openScreen('chat');
}

async function sendMessage(){
 const text=chatInput.value.trim();
 if(!text) return;

 if(tokens<=0){
  tokenModal.classList.add('active');
  return;
 }

 addMessage(text,'user');
 chatInput.value='';
 tokens--; stats.sent++;

 try{
  const res = await fetch(API_URL + "/chat", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      character: current.name,
      message: text
    })
  });

  const data = await res.json();
  addMessage(data.reply,'bot');
  stats.received++;

 }catch(e){
  addMessage("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚è≥",'bot');
 }

 localStorage.setItem('tokens',tokens);
 localStorage.setItem('stats',JSON.stringify(stats));
 updateProfile();
}

function addMessage(t,type){
 const d=document.createElement('div');
 d.className='msg '+type;
 d.textContent=t;
 chatMessages.appendChild(d);
 d.scrollIntoView({behavior:'smooth'});
}

function updateProfile(){
 tokensEl.textContent=tokens;
 statsText.textContent=`${stats.sent}/${stats.received}`;
}

function closeModal(){
 tokenModal.classList.remove('active');
}

renderCharacters();
updateProfile();
</script>

</body>
</html>
